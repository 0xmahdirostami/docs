<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">StEthPriceFeed | Lido Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://lidofinance.github.io/contracts/steth-price-feed"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="StEthPriceFeed | Lido Docs"><meta data-react-helmet="true" name="description" content="- Source Code"><meta data-react-helmet="true" property="og:description" content="- Source Code"><link data-react-helmet="true" rel="icon" href="/img/favicon-32x32.png"><link data-react-helmet="true" rel="canonical" href="https://lidofinance.github.io/contracts/steth-price-feed"><link data-react-helmet="true" rel="alternate" href="https://lidofinance.github.io/contracts/steth-price-feed" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://lidofinance.github.io/contracts/steth-price-feed" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.8c219a48.css">
<link rel="preload" href="/assets/js/runtime~main.36993eeb.js" as="script">
<link rel="preload" href="/assets/js/main.e723382b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Lido Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.svg" alt="Lido Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Lido Docs</b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/lidofinance" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_CDc6"><kbd class="searchHint_2RRg">ctrl</kbd><kbd class="searchHint_2RRg">K</kbd></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/lido-dao">Lido DAO</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/guides/steth-integration-guide">stETH/wstETH integration guide</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/guides/node-operator-manual">Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/integrations/sdk">Integrations</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/token-guides/steth-superuser-functions">Token guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/contracts/lido">Contracts</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contracts/lido">Lido</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contracts/lido-oracle">LidoOracle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contracts/stable-swap-state-oracle">StableSwapStateOracle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/contracts/steth-price-feed">StEthPriceFeed</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contracts/node-operators-registry">NodeOperatorsRegistry</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contracts/withdrawals-manager-stub">WithdrawalsManagerStub</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contracts/wsteth">wstETH</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contracts/deposit-security-module">DepositSecurityModule</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contracts/self-owned-steth-burner">SelfOwnedStETHBurner</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contracts/composite-post-rebase-beacon-receiver">CompositePostRebaseBeaconReceiver</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/contracts/lido-execution-layer-rewards-vault">LidoExecutionLayerRewardsVault</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/security/bugbounty">Security</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/deployed-contracts">Deployed Contracts</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>StEthPriceFeed</h1></header><ul><li><a href="https://github.com/lidofinance/steth-price-feed/blob/main/contracts/StEthPriceFeed.vy" target="_blank" rel="noopener noreferrer">Source Code</a></li><li><a href="https://etherscan.io/address/0xab55bf4dfbf469ebfe082b7872557d1f87692fe6" target="_blank" rel="noopener noreferrer">Deployed Contract</a></li></ul><p>Lido intends to provide secure and reliable price feed for stETH for protocols that intend to integrate it. Unfortunately, Chainlik is not available for stETH and Uniswap TWAP is not feasible at the moment: we&#x27;d want deep liquidity on stETH/ETH pair for this price, but Uni v2 doesn&#x27;t allow tight curves for similaraly-priced coins.</p><p>stETH has deep liquidity in the Curve pool but it doesn&#x27;t have a TWAP capability, so that&#x27;s out, too. In the moment Curve price is flashloanable, if not easily. We decided that in a pinch we can provide a &quot;price anchor&quot; that would attest that &quot;stETH/ETH price on Curve used to be around in recent past&quot; (implemented using the <a href="/contracts/stable-swap-state-oracle">StableSwapStateOracle</a>) and a price feed that could provide a reasonably safe estimation of current stETH/ETH price.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="vocabulary">Vocabulary<a class="hash-link" href="#vocabulary" title="Direct link to heading">â€‹</a></h2><ul><li><strong>Current price</strong>â€”current price of stETH on Curve pool. Flashloanable.</li><li><strong>Historical price</strong>â€”the price of stETH on Curve pool that was at least 15 blocks ago. May be older than 15 blocks: in that case, the pool price that was 15 blocks ago differs from the &quot;historical price&quot; by no more than <code>N</code>%.</li><li><strong>Safe price range</strong>â€”the range from <code>historical price - N%</code> to <code>min(historical price + N%, 1)</code>.</li><li><strong>Safe price</strong>â€”the price that&#x27;s within the safe price range.</li></ul><p>The parameter <code>N</code> is configured by the price feed admin; we&#x27;re planning to initially set it to <code>5%</code>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="steth-price-feed-specification">stETH price feed specification<a class="hash-link" href="#steth-price-feed-specification" title="Direct link to heading">â€‹</a></h2><p>The feed is used to fetch stETH/ETH pair price in a safe manner. By &quot;safe&quot; we mean that the price should be expensive to significantly manipulate in any direction, e.g. using flash loans or sandwich attacks.</p><p>The feed interfaces with two contracts:</p><ol><li>Curve stETH/ETH pool: <a href="https://github.com/curvefi/curve-contract/blob/c6df0cf/contracts/pools/steth/StableSwapSTETH.vy" target="_blank" rel="noopener noreferrer">source</a>, <a href="https://etherscan.io/address/0xdc24316b9ae028f1497c275eb9192a3ea0f67022" target="_blank" rel="noopener noreferrer">deployed contract</a>.</li><li><a href="/contracts/stable-swap-state-oracle">StableSwapStateOracle</a></li></ol><p>The pool is used as the main price source, and the oracle provides time-shifted price from the same pool used to establish a safe price range.</p><p>The price is defined as the amount of ETH wei needed to buy 1 stETH. For example, a price equal to <code>10**18</code> would mean that stETH is pegged 1:1 to ETH.</p><p>The safe price is defined as the one that satisfies all of the following conditions:</p><ul><li>The absolute value of percentage difference between the safe price and the time-shifted price fetched from the Merkle oracle is at most <code>max_safe_price_difference</code>.</li><li>The safe price is at most <code>10**18</code>, meaning that stETH cannot be more expensive than ETH.</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="fail-conditions">Fail conditions<a class="hash-link" href="#fail-conditions" title="Direct link to heading">â€‹</a></h2><p>Price feed can give incorrect data in, as far as we can tell, three situations:</p><ul><li>stETH/ETH price moving suddenly and very quickly. There is a 15 block or greater delay between a price drop and offchain oracle feed providers submitting a new historical price. It is usually longer than 15 blocks, because transactions are not mined instantaneously. Price movements this extreme should not happen normally; while stETH/ETH is volatile, it&#x27;s not 5%-in-four-minutes volatile.</li><li>oracle feed going stale because feed providers go offline. This is mitigated by the fact it&#x27;s operated by several very experienced professionals (all of which, e.g., are Chainlink operators too) - and we only need one operational provider to maintain the feed. The only realistic scenario where this feed goes offline is deprecating the oracle alltogether.</li><li>Multi-block flashloan attack. An block producer who is able to reliably get 2 blocks in a row can treat two blocks as an atomic transaction, leading to what is essentially a multiblock flashloan attack to manipulate price. That can lead to a short period of time (a few blocks) where stETH/ETH price feed is artificially manipulated. This attack is not mitigated, but in our opinion, not very realistic. It&#x27;s very hard to pull off.</li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="view-methods">View Methods<a class="hash-link" href="#view-methods" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="safe_price">safe_price()<a class="hash-link" href="#safe_price" title="Direct link to heading">â€‹</a></h3><p>Returns the cached safe price and its timestamp.</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">safe_price() -&gt; (price: uint256, timestamp: uint256)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="current_price">current_price()<a class="hash-link" href="#current_price" title="Direct link to heading">â€‹</a></h3><p>Returns the current pool price and whether the price is safe.</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">current_price() -&gt; (price: uint256, is_safe: bool)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="methods">Methods<a class="hash-link" href="#methods" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="update_safe_price">update_safe_price()<a class="hash-link" href="#update_safe_price" title="Direct link to heading">â€‹</a></h3><p>Sets the cached safe price to the <code>max(current pool price, 1)</code> given that the latter is safe.</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">update_safe_price() -&gt; uint256</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="fetch_safe_price">fetch_safe_price()<a class="hash-link" href="#fetch_safe_price" title="Direct link to heading">â€‹</a></h3><p>Returns the cached safe price and its timestamp. Calls <code>update_safe_price()</code> prior to that if
the cached safe price is older than <code>max_age</code> seconds.</p><div class="codeBlockContainer_J+bg theme-code-block"><div class="codeBlockContent_csEI"><pre tabindex="0" class="prism-code language-undefined codeBlock_rtdJ thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#bfc7d5"><span class="token plain">fetch_safe_price(max_age: uint256) -&gt; (price: uint256, timestamp: uint256)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="parameters">Parameters:<a class="hash-link" href="#parameters" title="Direct link to heading">â€‹</a></h4><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>max_age</code></td><td><code>uint256</code></td><td>Amount of seconds last value of safe price considered to be valid</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/lidofinance/docs/blob/main/docs/contracts/steth-price-feed.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/contracts/stable-swap-state-oracle"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">StableSwapStateOracle</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/contracts/node-operators-registry"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">NodeOperatorsRegistry</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#vocabulary" class="table-of-contents__link toc-highlight">Vocabulary</a></li><li><a href="#steth-price-feed-specification" class="table-of-contents__link toc-highlight">stETH price feed specification</a></li><li><a href="#fail-conditions" class="table-of-contents__link toc-highlight">Fail conditions</a></li><li><a href="#view-methods" class="table-of-contents__link toc-highlight">View Methods</a><ul><li><a href="#safe_price" class="table-of-contents__link toc-highlight">safe_price()</a></li><li><a href="#current_price" class="table-of-contents__link toc-highlight">current_price()</a></li></ul></li><li><a href="#methods" class="table-of-contents__link toc-highlight">Methods</a><ul><li><a href="#update_safe_price" class="table-of-contents__link toc-highlight">update_safe_price()</a></li><li><a href="#fetch_safe_price" class="table-of-contents__link toc-highlight">fetch_safe_price()</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.36993eeb.js"></script>
<script src="/assets/js/main.e723382b.js"></script>
</body>
</html>