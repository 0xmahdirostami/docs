"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[367],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return h}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),p=c(n),h=r,f=p["".concat(l,".").concat(h)]||p[h]||d[h]||o;return n?a.createElement(f,s(s({ref:t},u),{},{components:n})):a.createElement(f,s({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=p;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var c=2;c<o;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},9565:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return i},contentTitle:function(){return l},metadata:function(){return c},toc:function(){return u},default:function(){return p}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),s=["components"],i={},l="stETH on AAVE caveats",c={unversionedId:"token-guides/steth-on-aave-caveats",id:"token-guides/steth-on-aave-caveats",title:"stETH on AAVE caveats",description:"Flashloans",source:"@site/docs/token-guides/steth-on-aave-caveats.md",sourceDirName:"token-guides",slug:"/token-guides/steth-on-aave-caveats",permalink:"/token-guides/steth-on-aave-caveats",editUrl:"https://github.com/lidofinance/docs/blob/main/docs/token-guides/steth-on-aave-caveats.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"StETH superuser functions",permalink:"/token-guides/steth-superuser-functions"},next:{title:"Lido",permalink:"/contracts/lido"}},u=[{value:"Flashloans",id:"flashloans",children:[],level:3},{value:"Workarounds",id:"workarounds",children:[],level:3},{value:"Why does it happen?",id:"why-does-it-happen",children:[],level:3},{value:"Deposits",id:"deposits",children:[{value:"Deposit example",id:"deposit-example",children:[],level:4}],level:3}],d={toc:u};function p(e){var t=e.components,n=(0,r.Z)(e,s);return(0,o.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"steth-on-aave-caveats"},"stETH on AAVE caveats"),(0,o.kt)("h3",{id:"flashloans"},"Flashloans"),(0,o.kt)("p",null,"AAVE protocol allows borrowing any asset via flashloans, whether borrowing is enabled or not for the specific asset. Any user can borrow stETH on AAVE via a flashloan.",(0,o.kt)("br",{parentName:"p"}),"\n","Due to internal stETH mechanics required for rebasing support, in most cases stETH transfers are performed for the value of 1 wei less than passed to ",(0,o.kt)("inlineCode",{parentName:"p"},"transfer")," method. That could break returning a flashloan, with transaction reverting with ",(0,o.kt)("inlineCode",{parentName:"p"},"SafeERC20: low-level call failed")," error."),(0,o.kt)("h3",{id:"workarounds"},"Workarounds"),(0,o.kt)("p",null,"There are two workarounds:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Have at least 1 stETH wei more than it is required to close the flashoan. In this case, the amount of stETH transferred will be equal to or 1 wei greater than the loaned amount."),(0,o.kt)("li",{parentName:"ul"},"If leaving an extra wei is somehow not an option, you should check if the amount to transfer actually matches the loaned amount beforehand. This can be done using this formula:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"    uint256 exactTransferedAmount = StETH.getPooledEthByShares(StETH.getSharesByPooledEth(amount))\n")),(0,o.kt)("h3",{id:"why-does-it-happen"},"Why does it happen?"),(0,o.kt)("p",null,"Daily rebases of stETH are implemented via ",(0,o.kt)("inlineCode",{parentName:"p"},"shares"),", a basic unit representing the stETH holder's share in the total amount of ether controlled by the Lido protocol.\nBecause of math rounding down, there is a common case when the whole stETH balance can't be transferred from the account leaving 1 wei on the sender's account. This happens because the last wei is less than 1 share and gets rounded down to zero at transfer."),(0,o.kt)("h3",{id:"deposits"},"Deposits"),(0,o.kt)("p",null,"When depositing stETH to the lending pool on AAVE, the following statement is meant to be correct:",(0,o.kt)("br",{parentName:"p"}),"\n",'"At any time, a user can deposit X stETH to mint X astETH. Total astETH supply increases by X."',(0,o.kt)("br",{parentName:"p"}),"\n","In fact, the actual amount of astETH minted may be less than or equal to X because of double integer division (on stETH token rebase rate and AAVE interest rate).\nHowever, the actual rounding error is not expected to exceed a couple of wei at any time. Meanwhile, the event emitted will report the full initially deposited amount."),(0,o.kt)("h4",{id:"deposit-example"},"Deposit example"),(0,o.kt)("p",null,"In this ",(0,o.kt)("a",{parentName:"p",href:"https://etherscan.io/tx/0xd599641193da40080f3effa175874624f49a8efd6f5b748abd8bc7950fc270f0"},"deposit case")," we can see 369 stETH being deposited to AAVE stETH lending pool. But in fact, 368.999999999999999999 stETH have been transferred from sender and 368.999999999999999998 astETH have been minted on sender's address.\nHowever, the events were emitted about exactly 369 stETH transferred and 369 astETH minted."))}p.isMDXComponent=!0}}]);