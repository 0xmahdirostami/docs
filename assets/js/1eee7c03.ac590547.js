"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[9922],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=d(n),m=o,h=u["".concat(l,".").concat(m)]||u[m]||c[m]||r;return n?a.createElement(h,i(i({ref:t},p),{},{components:n})):a.createElement(h,i({ref:t},p))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:o,i[1]=s;for(var d=2;d<r;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5081:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var a=n(3117),o=(n(7294),n(3905));const r={},i="General Information",s={unversionedId:"guides/node-operators/exits/general-information",id:"guides/node-operators/exits/general-information",title:"General Information",description:"What Are Exit Messages?",source:"@site/docs/guides/node-operators/exits/general-information.md",sourceDirName:"guides/node-operators/exits",slug:"/guides/node-operators/exits/general-information",permalink:"/guides/node-operators/exits/general-information",draft:!1,editUrl:"https://github.com/lidofinance/docs/blob/main/docs/guides/node-operators/exits/general-information.md",tags:[],version:"current",frontMatter:{},sidebar:"docs",previous:{title:"Introduction",permalink:"/guides/node-operators/exits/introduction"},next:{title:"Exit Message Generation & Signing",permalink:"/guides/node-operators/exits/exit-message-generation-signing"}},l={},d=[{value:"What Are Exit Messages?",id:"what-are-exit-messages",level:2},{value:"Pre-sign or Not to Pre-sign",id:"pre-sign-or-not-to-pre-sign",level:2},{value:"How Many Keys to Pre-sign",id:"how-many-keys-to-pre-sign",level:2},{value:"How to Understand Which Keys to Pre-sign",id:"how-to-understand-which-keys-to-pre-sign",level:2},{value:"Using KAPI (recommended)",id:"using-kapi-recommended",level:3},{value:"Manually",id:"manually",level:3},{value:"Storing Signed Exit Messages",id:"storing-signed-exit-messages",level:2},{value:"How to Initiate a Validator Exit",id:"how-to-initiate-a-validator-exit",level:2}],p={toc:d},u="wrapper";function c(e){let{components:t,...n}=e;return(0,o.kt)(u,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"general-information"},"General Information"),(0,o.kt)("h2",{id:"what-are-exit-messages"},"What Are Exit Messages?"),(0,o.kt)("p",null,"To initiate a validator exit, an ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/ethereum/consensus-specs/blob/v1.0.1/specs/phase0/beacon-chain.md#voluntaryexit"},"exit message")," needs to be generated, signed and submitted to a Consensus Node."),(0,o.kt)("p",null,"It looks like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "message": { "epoch": "123", "validator_index": "123" },\n  "signature": "0x123"\n}\n')),(0,o.kt)("p",null,"After it's generated, it is signed using the validator BLS key which needs to be exited and a ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/ethereum/consensus-specs/blob/v1.0.1/specs/phase0/beacon-chain.md#signedvoluntaryexit"},"signed exit message")," is formed."),(0,o.kt)("h2",{id:"pre-sign-or-not-to-pre-sign"},"Pre-sign or Not to Pre-sign"),(0,o.kt)("p",null,"In short, it's a well balanced solution allowing to achieve meaningful automation without sacrificing security or decentralisation."),(0,o.kt)("p",null,"You can find the reasoning behind the suggested approach in the ",(0,o.kt)("a",{parentName:"p",href:"https://hackmd.io/@lido/BkxRxAr-o"},"Lido Withdrawals: Automating Validator Exits RFC"),"."),(0,o.kt)("p",null,"However, if you have existing tooling in place to create and send out exit messages, you can use webhook mode of the Ejector which will call an endpoint in order to initiate a validator exit."),(0,o.kt)("p",null,"On the endpoint, JSON will be POSTed with the following structure:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n        "validatorIndex": "123"\n        "validatorPubkey": "0x123"\n}\n')),(0,o.kt)("p",null,"200 response will be counted as a successful exit, non-200 as a fail."),(0,o.kt)("p",null,"If it's not enough, you'll have to fork the Ejector or monitor ",(0,o.kt)("inlineCode",{parentName:"p"},"ValidatorExitRequest")," events of the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/lidofinance/lido-dao/blob/feature/shapella-upgrade/contracts/0.8.9/oracle/ValidatorsExitBusOracle.sol"},(0,o.kt)("inlineCode",{parentName:"a"},"ValidatorsExitBusOracle"))," in your tooling."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/lidofinance/validator-ejector/blob/d72cac9767a57936f29c5b54e7de4f74344342de/src/services/execution-api/service.ts#L160-L203"},"Example in the Ejector")),(0,o.kt)("h2",{id:"how-many-keys-to-pre-sign"},"How Many Keys to Pre-sign"),(0,o.kt)("p",null,"Node Operators should pre-sign an amount or a percentage of validators which they are comfortable with managing. Smaller amounts means more frequent refills and vice versa."),(0,o.kt)("p",null,"For Withdrawals preparations, for example, exits for 10% of the validators pre-signed is suggested. After that, it wilsl depend on the Withdrawals demand and Node Operator preferences."),(0,o.kt)("h2",{id:"how-to-understand-which-keys-to-pre-sign"},"How to Understand Which Keys to Pre-sign"),(0,o.kt)("h3",{id:"using-kapi-recommended"},"Using KAPI (recommended)"),(0,o.kt)("p",null,"First endpoint returns a list of validators for a specific Node Operator, for which to generate and sign exit messages next:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"/v1/modules/{module_id}/validators/validator-exits-to-prepare/{operator_id}")),(0,o.kt)("p",null,"Returns data:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'[{\n    "validatorIndex": 123;\n    "key": "0x123";\n}]\n')),(0,o.kt)("p",null,"Additionally, there is also a second endpoint which calculates the same data, but returns ready to sign exit messages:"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"/v1/modules/{module_id}/validators/generate-unsigned-exit-messages/{operator_id}")),(0,o.kt)("admonition",{type:"danger"},(0,o.kt)("p",{parentName:"admonition"},"Make sure to visually inspect the returned data as a precaution as you will be signing it.\nYou can find the expected format in the ",(0,o.kt)("a",{parentName:"p",href:"#what-are-exit-messages"},"What Are Exit Messages")," section.")),(0,o.kt)("p",null,"Returns data:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'[{\n    "validator_index": "123";\n    "epoch": "123";\n}]\n')),(0,o.kt)("p",null,"Furthermore, both endpoints allow for additional configuration via query parameters:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"percent")," - Percent of validators to return data for. Default value is 10."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"max_amount")," - Number of validators to return data for. If validator number is less than the specified amount, all validators are returned.")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Note: Only one parameter is active at a time. If both are provided, ",(0,o.kt)("inlineCode",{parentName:"p"},"percent")," has a higher priority.")),(0,o.kt)("p",null,"KAPI will automatically filter out validators which are exited already or are currently exiting, so one call to the KAPI is all that's needed."),(0,o.kt)("h3",{id:"manually"},"Manually"),(0,o.kt)("p",null,"If your validator signing keys are stored in generation order, you can simply start exit generation and signing from the oldest keys since the exit algorithm is deterministic and will choose oldest keys first for each Node Operator."),(0,o.kt)("p",null,"However, for each batch you'll need to either track the last key exit message was generated for or query validator statuses on the Consensus Node to understand where to start next."),(0,o.kt)("h2",{id:"storing-signed-exit-messages"},"Storing Signed Exit Messages"),(0,o.kt)("p",null,"Storing signed exit messages as-is is discouraged. If an attacker gains access to them, they will simply submit them, which will exit every validator for which you had exit messages."),(0,o.kt)("p",null,"It's recommended to encrypt the messages, for example using the encryption script provided with the Ejector."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://hackmd.io/@lido/BJvy7eWln#Encrypting-Messages"},"How to Use the Ejector Encryptor")),(0,o.kt)("p",null,"You can also check out the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/lidofinance/validator-ejector/blob/develop/encryptor/encrypt.ts"},"source code")," and integrate it in your own tooling if needed."),(0,o.kt)("p",null,"Ejector automatically decrypts ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/ethereum/EIPs/blob/master/EIPS/eip-2335.md"},"EIP-2335"),"-encrypted files on app start."),(0,o.kt)("h2",{id:"how-to-initiate-a-validator-exit"},"How to Initiate a Validator Exit"),(0,o.kt)("p",null,"Signed messages are sent to a Consensus Node via the ",(0,o.kt)("inlineCode",{parentName:"p"},"/eth/v1/beacon/pool/voluntary_exits")," endpoint in order to initiate an exit."),(0,o.kt)("p",null,"The Ejector will do this automatically when necessary."),(0,o.kt)("p",null,"If you don't run the Ejector, you'll have to do this manually or develop your own tooling.\nIf your exit messages are encrypted, you'll need to decrypt them first."))}c.isMDXComponent=!0}}]);